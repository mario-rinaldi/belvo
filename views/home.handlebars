<body class="bg-gradient-primary"></body>

<div id="belvo"></div>

<script>
function getAccessToken() {
    return fetch(`../token`, {method: "GET"})
        .then((response) => response.json())
        .then((data) => data.access)
        .catch((error) => console.error("Error:",error));
}

function openBelvoWidget(accessToken) {
    belvoSDK.createWidget(accessToken, {
        access_mode: 'recurrent', //single or recurrent
        country_codes: ['BR'],
        locale: 'en',
        callback: (link, institution) => successCallbackFunction(link, institution),
        onExit: (event) => console.log(event),
        onEvent: (event) => console.log(event)
    }).build();
}

async function successCallbackFunction(link, institution) {
    
    
    var socket = io()
    data = {institution: institution, link: link}
    socket.emit('callbackBelvo', data)
    socket.on('redirect', (targetPath) => {
        //window.location.replace(encodeURI(window.location.origin + targetPath));
        console.log(encodeURI(window.location.origin + targetPath))
        
        // get handle of parent element
        let element = document.querySelector('#main');

        // set inner HTML of parent container
        element.innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border text-primary m-5" style="width: 3rem; height: 3rem;" role="status"><span class="sr-only">Loading...</span></div></div>';

        setTimeout(continueButton, 5000)

        function continueButton() {
            console.log('esperei 5 segundos')
            element.innerHTML = '<div class="d-flex justify-content-center"><div class="my-2"></div>' +
                                '<a href="' + encodeURI(window.location.origin + targetPath) + '" class="btn btn-success btn-icon-split">' +
                                '<span class="icon text-white-50">' +
                                '<i class="fas fa-check"></i></span>' +
                                '<span class="text">Click here to see the data</span></a>' +
                                '<div class="my-2"></div></div>'
        }
    });
}

async function loadBelvo() {
    getAccessToken().then(openBelvoWidget);
}
</script>


    <div class="container">

        <div class="card o-hidden border-10 shadow-lg my-5">
            <div class="card-body p-0">
                <!-- Nested Row within Card Body -->
                <div class="row">
                    <div class="col-lg-5 d-none d-lg-block bg-register-image"></div>
                    <div class="col-lg-7">
                        <div id="main" class="p-5">

                            <div class="text-center">
                                <h1 class="h4 text-gray-900 mb-4">Oh, hi there! ðŸ‘‹</h1>
                            </div>
                            <button onclick="loadBelvo()" class="btn btn-primary btn-user btn-block">
                                Connect using BelvoÂ®
                            </button>
                            <hr>
                            <a href="https://www.linkedin.com/in/mlealrinaldi/?locale=en_US" class="btn btn-facebook btn-user btn-block" target="_blank">
                                <img src="static/img/LI-In-Bug.svg" width="25" height="20"></img> Developer's LinkedIn Profile
                            </a>

                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>